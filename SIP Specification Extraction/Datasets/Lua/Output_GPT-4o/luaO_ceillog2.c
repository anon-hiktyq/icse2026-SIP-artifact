
#include "luaO_ceillog2.h"

/*@ logic integer log_2(integer x) = 
      x == 0 ? 0 :
      x == 1 ? 0 :
      x == 2 ? 1 :
      x == 3 ? 2 :
      x == 4 ? 2 :
      x == 5 ? 3 :
      x == 6 ? 3 :
      x == 7 ? 3 :
      x == 8 ? 3 :
      x == 9 ? 4 :
      x == 10 ? 4 :
      x == 11 ? 4 :
      x == 12 ? 4 :
      x == 13 ? 4 :
      x == 14 ? 4 :
      x == 15 ? 4 :
      x == 16 ? 4 :
      x == 17 ? 5 :
      x == 18 ? 5 :
      x == 19 ? 5 :
      x == 20 ? 5 :
      x == 21 ? 5 :
      x == 22 ? 5 :
      x == 23 ? 5 :
      x == 24 ? 5 :
      x == 25 ? 5 :
      x == 26 ? 5 :
      x == 27 ? 5 :
      x == 28 ? 5 :
      x == 29 ? 5 :
      x == 30 ? 5 :
      x == 31 ? 5 :
      x == 32 ? 5 :
      x == 33 ? 6 :
      x == 34 ? 6 :
      x == 35 ? 6 :
      x == 36 ? 6 :
      x == 37 ? 6 :
      x == 38 ? 6 :
      x == 39 ? 6 :
      x == 40 ? 6 :
      x == 41 ? 6 :
      x == 42 ? 6 :
      x == 43 ? 6 :
      x == 44 ? 6 :
      x == 45 ? 6 :
      x == 46 ? 6 :
      x == 47 ? 6 :
      x == 48 ? 6 :
      x == 49 ? 6 :
      x == 50 ? 6 :
      x == 51 ? 6 :
      x == 52 ? 6 :
      x == 53 ? 6 :
      x == 54 ? 6 :
      x == 55 ? 6 :
      x == 56 ? 6 :
      x == 57 ? 6 :
      x == 58 ? 6 :
      x == 59 ? 6 :
      x == 60 ? 6 :
      x == 61 ? 6 :
      x == 62 ? 6 :
      x == 63 ? 6 :
      x == 64 ? 6 :
      x == 65 ? 7 :
      x == 66 ? 7 :
      x == 67 ? 7 :
      x == 68 ? 7 :
      x == 69 ? 7 :
      x == 70 ? 7 :
      x == 71 ? 7 :
      x == 72 ? 7 :
      x == 73 ? 7 :
      x == 74 ? 7 :
      x == 75 ? 7 :
      x == 76 ? 7 :
      x == 77 ? 7 :
      x == 78 ? 7 :
      x == 79 ? 7 :
      x == 80 ? 7 :
      x == 81 ? 7 :
      x == 82 ? 7 :
      x == 83 ? 7 :
      x == 84 ? 7 :
      x == 85 ? 7 :
      x == 86 ? 7 :
      x == 87 ? 7 :
      x == 88 ? 7 :
      x == 89 ? 7 :
      x == 90 ? 7 :
      x == 91 ? 7 :
      x == 92 ? 7 :
      x == 93 ? 7 :
      x == 94 ? 7 :
      x == 95 ? 7 :
      x == 96 ? 7 :
      x == 97 ? 7 :
      x == 98 ? 7 :
      x == 99 ? 7 :
      x == 100 ? 7 :
      x == 101 ? 7 :
      x == 102 ? 7 :
      x == 103 ? 7 :
      x == 104 ? 7 :
      x == 105 ? 7 :
      x == 106 ? 7 :
      x == 107 ? 7 :
      x == 108 ? 7 :
      x == 109 ? 7 :
      x == 110 ? 7 :
      x == 111 ? 7 :
      x == 112 ? 7 :
      x == 113 ? 7 :
      x == 114 ? 7 :
      x == 115 ? 7 :
      x == 116 ? 7 :
      x == 117 ? 7 :
      x == 118 ? 7 :
      x == 119 ? 7 :
      x == 120 ? 7 :
      x == 121 ? 7 :
      x == 122 ? 7 :
      x == 123 ? 7 :
      x == 124 ? 7 :
      x == 125 ? 7 :
      x == 126 ? 7 :
      x == 127 ? 7 :
      x == 128 ? 7 :
      x == 129 ? 8 :
      x == 130 ? 8 :
      x == 131 ? 8 :
      x == 132 ? 8 :
      x == 133 ? 8 :
      x == 134 ? 8 :
      x == 135 ? 8 :
      x == 136 ? 8 :
      x == 137 ? 8 :
      x == 138 ? 8 :
      x == 139 ? 8 :
      x == 140 ? 8 :
      x == 141 ? 8 :
      x == 142 ? 8 :
      x == 143 ? 8 :
      x == 144 ? 8 :
      x == 145 ? 8 :
      x == 146 ? 8 :
      x == 147 ? 8 :
      x == 148 ? 8 :
      x == 149 ? 8 :
      x == 150 ? 8 :
      x == 151 ? 8 :
      x == 152 ? 8 :
      x == 153 ? 8 :
      x == 154 ? 8 :
      x == 155 ? 8 :
      x == 156 ? 8 :
      x == 157 ? 8 :
      x == 158 ? 8 :
      x == 159 ? 8 :
      x == 160 ? 8 :
      x == 161 ? 8 :
      x == 162 ? 8 :
      x == 163 ? 8 :
      x == 164 ? 8 :
      x == 165 ? 8 :
      x == 166 ? 8 :
      x == 167 ? 8 :
      x == 168 ? 8 :
      x == 169 ? 8 :
      x == 170 ? 8 :
      x == 171 ? 8 :
      x == 172 ? 8 :
      x == 173 ? 8 :
      x == 174 ? 8 :
      x == 175 ? 8 :
      x == 176 ? 8 :
      x == 177 ? 8 :
      x == 178 ? 8 :
      x == 179 ? 8 :
      x == 180 ? 8 :
      x == 181 ? 8 :
      x == 182 ? 8 :
      x == 183 ? 8 :
      x == 184 ? 8 :
      x == 185 ? 8 :
      x == 186 ? 8 :
      x == 187 ? 8 :
      x == 188 ? 8 :
      x == 189 ? 8 :
      x == 190 ? 8 :
      x == 191 ? 8 :
      x == 192 ? 8 :
      x == 193 ? 8 :
      x == 194 ? 8 :
      x == 195 ? 8 :
      x == 196 ? 8 :
      x == 197 ? 8 :
      x == 198 ? 8 :
      x == 199 ? 8 :
      x == 200 ? 8 :
      x == 201 ? 8 :
      x == 202 ? 8 :
      x == 203 ? 8 :
      x == 204 ? 8 :
      x == 205 ? 8 :
      x == 206 ? 8 :
      x == 207 ? 8 :
      x == 208 ? 8 :
      x == 209 ? 8 :
      x == 210 ? 8 :
      x == 211 ? 8 :
      x == 212 ? 8 :
      x == 213 ? 8 :
      x == 214 ? 8 :
      x == 215 ? 8 :
      x == 216 ? 8 :
      x == 217 ? 8 :
      x == 218 ? 8 :
      x == 219 ? 8 :
      x == 220 ? 8 :
      x == 221 ? 8 :
      x == 222 ? 8 :
      x == 223 ? 8 :
      x == 224 ? 8 :
      x == 225 ? 8 :
      x == 226 ? 8 :
      x == 227 ? 8 :
      x == 228 ? 8 :
      x == 229 ? 8 :
      x == 230 ? 8 :
      x == 231 ? 8 :
      x == 232 ? 8 :
      x == 233 ? 8 :
      x == 234 ? 8 :
      x == 235 ? 8 :
      x == 236 ? 8 :
      x == 237 ? 8 :
      x == 238 ? 8 :
      x == 239 ? 8 :
      x == 240 ? 8 :
      x == 241 ? 8 :
      x == 242 ? 8 :
      x == 243 ? 8 :
      x == 244 ? 8 :
      x == 245 ? 8 :
      x == 246 ? 8 :
      x == 247 ? 8 :
      x == 248 ? 8 :
      x == 249 ? 8 :
      x == 250 ? 8 :
      x == 251 ? 8 :
      x == 252 ? 8 :
      x == 253 ? 8 :
      x == 254 ? 8 :
      x == 255 ? 8 :
      x == 256 ? 8 : 0;
*/

/*@ axiomatic CeilLog2 {
      logic integer ceil_log2(integer x) = 
        x == 0 ? 0 : 
        x < 256 ? log_2(x) : 
        ceil_log2(x >> 8) + 8;
    }
*/

/*@ requires \valid(pIp);
    requires \valid(pIp->ret);
    requires pIp->x >= 0;
    assigns pIp->x, *(pIp->ret);
    ensures *(pIp->ret) == ceil_log2(\old(pIp->x));
*/
void luaO_ceillog2Fun(luaO_ceillog2 *pIp) 
{
  static const lu_byte log_2[256] = {  /* log_2[i - 1] = ceil(log2(i)) */
    0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,
    6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,
    7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
    7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,
    8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,
    8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,
    8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,
    8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8
  };
  int l = 0;
  pIp -> x--;
  /*@ loop invariant 0 <= l;
      loop invariant pIp->x == \at(pIp->x, Pre) >> (l / 8 * 8);
      loop assigns l, pIp->x;
      loop variant 256 - pIp->x;
  */
  while (pIp -> x >= 256) { l += 8; pIp -> x >>= 8; }
  *(pIp -> ret) = cast_byte(l + log_2[pIp->x]);
}
